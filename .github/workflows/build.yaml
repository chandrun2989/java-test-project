name: "build test"

on:
  workflow_dispatch:


jobs:
  maven_test:
    runs-on: self-hosted

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Snyk to check for configuration vulnerabilities
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          set +e
          snyk iac test ./terraform --severity-threshold=high > snyk_report.txt 2>&1
          EXIT_CODE=$?
          set -e
          cat snyk_report.txt
          echo "### Snyk IaC Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "<details><summary>Click to expand scan results</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          cat snyk_report.txt >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
          if [ $EXIT_CODE -ne 0 ]; then
            exit $EXIT_CODE
          fi
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          server-id: nexus-snapshots # ID from the settings.xml to match 
          server-username: MAVEN_USERNAME # Env var name we will map below
          server-password: MAVEN_PASSWORD # Env var name we will map below

      
      - name: Publish to Nexus
        run: mvn deploy -DskipTests
        env:
          MAVEN_USERNAME: ${{ secrets.NEXUS_USERNAME }}
          MAVEN_PASSWORD: ${{ secrets.NEXUS_PASSWORD }}